<?xml version="1.0" encoding="ISO-8859-1"?>
<project name="gae" default="testdist">

  <property name="version.major" value="0"/>
  <property name="version.minor" value="8"/>
  <property name="version.point" value="6"/>
  <property name="version" value="${version.major}.${version.minor}.${version.point}"/>
  <property name="orm.source.zip" value="datanucleus-appengine-${version}-src.zip"/>
  <property name="orm.jar" value="datanucleus-appengine-${version}.jar"/>
  <property name="zip.prefix" value="appengine-orm"/>
  <property name="dist.target" value="${zip.prefix}-${version}.zip"/>
  <property name="plugin.src.dir" value="../src"/>
  <property name="helloorm.src.dir" value="../demos/helloorm/src"/>
  <property name="orm.tmp.dir" value="/tmp/orm"/>
  <property name="compile.dest.dir" value="${orm.tmp.dir}/classes"/>
  <property name="orm.lib.dir" value="../lib"/>
  <property name="orm.tmpdist.dir" value="/tmp/testdist"/>
  <property name="orm.sdk.tmpdist.dir" value="${orm.tmpdist.dir}/lib"/>

  <path id="appengine.plugin.classpath">
    <pathelement location="${orm.lib.dir}/jdo2-api-2.2.jar"/>
    <pathelement location="${orm.lib.dir}/geronimo-jpa_3.0_spec-1.0.jar"/>
    <pathelement location="${orm.lib.dir}/datanucleus-core-1.1.0.m1.jar"/>
    <pathelement location="${orm.lib.dir}/datanucleus-jpa-1.1.0.m1.jar"/>
    <pathelement location="${orm.lib.dir}/appengine-api.jar"/>
  </path>

  <path id="appengine.helloorm.classpath">
    <pathelement location="${orm.lib.dir}/jdo2-api-2.2.jar"/>
    <pathelement location="${orm.lib.dir}/geronimo-jpa_3.0_spec-1.0.jar"/>
    <pathelement location="${orm.lib.dir}/servlet-api-2.5.jar"/>
  </path>

  <target name="compile" description="Compile the datanucleus appengine plugin">
    <delete dir="${compile.dest.dir}"/>
    <mkdir dir="${compile.dest.dir}"/>
    <javac classpathref="appengine.plugin.classpath" debug="on" source="1.5" target="1.5"
        srcdir="${plugin.src.dir}" destdir="${compile.dest.dir}"/>
  </target>

  <target name="package-demos" depends="enhance-demos" description="Package the appengine orm demos">
    <copy todir="${compile.dest.dir}">
      <fileset dir="${helloorm.src.dir}">
        <include name="META-INF/*"/>
      </fileset>
    </copy>
    <war destfile="helloorm.war" webxml="${helloorm.src.dir}/WEB-INF/web.xml">
      <lib dir="${orm.lib.dir}">
        <include name="datanucleus-core*.jar"/>
        <include name="datanucleus-jpa*.jar"/>
        <include name="geronimo*.jar"/>
        <include name="jdo2-api*.jar"/>
        <include name="appengine-api.jar"/>
      </lib>
      <lib dir=".">
        <include name="${orm.jar}"/>
      </lib>
      <classes dir="${compile.dest.dir}"/>
      <webinf dir="${helloorm.src.dir}/WEB-INF">
        <include name="appengine-web.xml"/>
      </webinf>
    </war>
    <delete dir="${orm.tmp.dir}/exploded"/>
    <mkdir dir="${orm.tmp.dir}/exploded"/>
    <unwar src="helloorm.war" dest="${orm.tmp.dir}/exploded"/>
  </target>

  <path id="demos.enhancer.classpath">
    <pathelement location="${orm.lib.dir}/jdo2-api-2.2.jar"/>
    <pathelement location="${orm.lib.dir}/geronimo-jpa_3.0_spec-1.0.jar"/>
    <pathelement location="${orm.lib.dir}/datanucleus-core-1.1.0.m1.jar"/>
    <pathelement location="${orm.lib.dir}/datanucleus-enhancer-1.0.1.jar"/>
    <pathelement location="${orm.lib.dir}/datanucleus-jpa-1.1.0.m1.jar"/>
    <pathelement location="${orm.lib.dir}/appengine-api.jar"/>
    <pathelement location="${orm.lib.dir}/asm-3.1.jar"/>
    <pathelement location="${compile.dest.dir}"/>
  </path>

  <target name="enhance-demos" description="enhance" depends="compile-demos">
    <taskdef name="datanucleusenhancer" classpathref="demos.enhancer.classpath"
             classname="org.datanucleus.enhancer.tools.EnhancerTask"/>

    <datanucleusenhancer classpathref="demos.enhancer.classpath" failonerror="true">
      <fileset dir="${compile.dest.dir}">
        <include name="**/*.class"/>
      </fileset>
    </datanucleusenhancer>
  </target>

  <target name="compile-demos" description="Compile the datanucleus appengine orm demos">
    <!-- Right now we only have one demo -->
    <delete dir="${compile.dest.dir}"/>
    <mkdir dir="${compile.dest.dir}"/>
    <javac classpathref="appengine.helloorm.classpath" debug="on" source="1.5" target="1.5"
        srcdir="${helloorm.src.dir}" destdir="${compile.dest.dir}"/>
  </target>

  <target name="jar" depends="compile" description="Jar the compiled datanucleus appengine plugin">
    <!-- need to copy over all non-java resources -->
    <copy todir="${compile.dest.dir}">
      <fileset dir="${plugin.src.dir}">
        <include name="**/*.xml"/>
        <include name="**/*.properties"/>
        <include name="**/*.MF"/>
        <include name="META-INF/services/**"/>
      </fileset>
    </copy>
    <jar destfile="${orm.jar}" basedir="${compile.dest.dir}">
      <manifest>
        <attribute name="Manifest-Version" value="1.0"/>
        <attribute name="Bundle-ManifestVersion" value="2"/>
        <attribute name="Bundle-Name" value="DataNucleus AppEngine"/>
        <attribute name="Bundle-SymbolicName" value="org.datanucleus.store.appengine;singleton:=true"/>
        <attribute name="Bundle-Version" value="${version}"/>
        <attribute name="Bundle-Vendor" value="Google"/>
        <attribute name="Require-Bundle" value="org.datanucleus;bundle-version=&quot;[1.1.0.m4)&quot;"/>
        <attribute name="Import-Package" value="javax.jdo, javax.jdo.annotations, javax.jdo.datastore, javax.jdo.identity, javax.jdo.listener, javax.persistence, javax.persistence.spi"/>
      </manifest>
    </jar>
    <!-- Extract the manifest and copy it back into the source tree -->
    <mkdir dir="${orm.tmp.dir}/exploded"/>
    <unzip src="${orm.jar}" dest="${orm.tmp.dir}/exploded"/>
    <copy file="${orm.tmp.dir}/exploded/META-INF/MANIFEST.MF" todir="${plugin.src.dir}/META-INF"/>
    <delete dir="${orm.tmp.dir}/exploded"/>
  </target>

  <target name="dist" depends="compile, jar, package-demos" description="Build the datanucleus appengine distribution">
    <zip destfile="${orm.source.zip}">
      <fileset dir="${plugin.src.dir}" includes="**/*"/>
    </zip>
    <zip destfile="${dist.target}">
      <zipfileset prefix="demos/helloorm/src" dir="../demos/helloorm/src">
        <include name="**"/>
        <exclude name="**/*.iml"/>
      </zipfileset>
      <zipfileset prefix="demos/helloorm/www" dir="${orm.tmp.dir}/exploded">
        <include name="**"/>
        <exclude name="META-INF/**"/>
      </zipfileset>
      <zipfileset prefix="docs" dir="../doc">
        <include name="**"/>
      </zipfileset>
      <zipfileset prefix="lib/tools/orm" dir="${orm.lib.dir}">
        <include name="asm*.jar"/>
        <include name="jdo2-api*.jar"/>
        <include name="geronimo*.jar"/>
        <include name="datanucleus-enhancer*.jar"/>
        <include name="datanucleus-jpa*.jar"/>
        <include name="datanucleus-core*.jar"/>
      </zipfileset>
      <zipfileset prefix="lib/user/orm" dir="${orm.lib.dir}">
        <include name="jdo2-api*.jar"/>
        <include name="geronimo*.jar"/>
        <include name="datanucleus-jpa*.jar"/>
        <include name="datanucleus-core*.jar"/>
      </zipfileset>
      <zipfileset prefix="lib/user/orm" file="${orm.jar}"/>
      <zipfileset prefix="src/orm" file="${orm.source.zip}"/>
      <zipfileset prefix="src/orm" dir="${orm.lib.dir}">
        <include name="datanucleus-*src*"/>
      </zipfileset>
      <zipfileset file="README.ORM"/>
    </zip>
    <delete file="${orm.jar}"/>
    <delete file="${orm.source.zip}"/>
  </target>

  <target name="testdist" depends="dist"
          description="Unzip the dist, launch one of the sample apps, and hit it
                       with curl to make sure it is functioning properly.">
    <!--
      Setup a directory for the test distribution
      It should look like this:
      /tmp/testdist/lib
      /tmp/testdist/lib/appengine-tools-api.jar
      /tmp/testdist/lib/impl/appengine-local-runtime.jar
      /tmp/testdist/lib/impl/appengine-api.jar
      /tmp/testdist/lib/impl/appengine-api-stubs.jar
      /tmp/testdist/lib/shared/servlet-api-2.5 .jar
      /tmp/testdist/lib/shared/jsp-api-2.1 .jar
      /tmp/testdist/lib/shared/el-api-2.1 .jar
      /tmp/testdist/lib/shared/appengine-local-runtime-shared.jar
     -->
    <delete dir="${orm.tmpdist.dir}"/>
    <mkdir dir="${orm.tmpdist.dir}"/>

    <!-- Now setup a directory that contains the sdk jars we need to run the demos -->
    <mkdir dir="${orm.sdk.tmpdist.dir}"/>
    <copy todir="${orm.sdk.tmpdist.dir}">
      <fileset dir="${orm.lib.dir}">
        <include name="appengine-tools-api.jar"/>
      </fileset>
    </copy>

    <mkdir dir="${orm.sdk.tmpdist.dir}/impl"/>
    <copy todir="${orm.sdk.tmpdist.dir}/impl">
      <fileset dir="${orm.lib.dir}">
        <include name="appengine-local-runtime.jar"/>
        <include name="appengine-api-stubs.jar"/>
        <include name="appengine-api.jar"/>
      </fileset>
    </copy>

    <mkdir dir="${orm.sdk.tmpdist.dir}/shared"/>
    <copy todir="${orm.sdk.tmpdist.dir}/shared">
      <fileset dir="${orm.lib.dir}">
        <include name="appengine-local-runtime-shared.jar"/>
        <include name="servlet-api*.jar"/>
        <include name="jsp-api*.jar"/>
        <include name="el-api*.jar"/>
      </fileset>
    </copy>

    <unzip src="${dist.target}" dest="${orm.tmpdist.dir}"/>

    <parallel>
      <daemons>
        <java fork="true" classpath="${orm.sdk.tmpdist.dir}/appengine-tools-api.jar"
              classname="com.google.appengine.tools.development.DevAppServerMain">
          <jvmarg value="-Xdebug"/>
          <!--<jvmarg value="-Xrunjdwp:transport=dt_socket,server=y,suspend=y,address=5005"/>-->
          <arg value="${orm.tmpdist.dir}/demos/helloorm/www"/>
        </java>
      </daemons>
      <sequential>
        <sleep seconds="8"/>

        <!-- create a flight -->
        <exec executable="curl" failifexecutionfails="true" failonerror="true">
          <arg value="-d"/>
          <arg value="orig=BOS&amp;dest=LAX"/>
          <arg value="http://localhost:8080/addFlight"/>
        </exec>
        <exec executable="curl" failifexecutionfails="true" failonerror="true" outputproperty="curl.add.result">
          <arg value="http://localhost:8080"/>
        </exec>
        <condition property="expected.add.response">
          <contains string="${curl.add.result}" substring="aghoZWxsb29ybXIMCxIGRmxpZ2h0GAEM"/>
        </condition>
        <fail unless="expected.add.response" message="Did not get the expected add response: ${curl.add.result}${line.separator}${line.separator}    BUILD FAILED!!!!"/>

         <!-- issue a jpql query -->
        <exec executable="curl" failifexecutionfails="true" failonerror="true" outputproperty="curl.query.result">
          <arg value="-d"/>
          <arg value="q=select f from com.google.appengine.demos.helloorm.Flight f where orig = 'BOS'"/>
          <arg value="http://localhost:8080"/>
        </exec>
        <condition property="expected.query.response">
          <contains string="${curl.query.result}" substring="aghoZWxsb29ybXIMCxIGRmxpZ2h0GAEM"/>
        </condition>
        <fail unless="expected.query.response" message="Did not get the expected query response: ${curl.query.result}${line.separator}${line.separator}    BUILD FAILED!!!!"/>

        <!-- switch to jdo -->
       <exec executable="curl" failifexecutionfails="true" failonerror="true">
         <arg value="-d"/>
         <arg value="persistenceStandard=JDO"/>
         <arg value="http://localhost:8080/updatePersistenceStandard"/>
       </exec>
        <exec executable="curl" failifexecutionfails="true" failonerror="true" outputproperty="curl.switchps.result">
          <arg value="http://localhost:8080"/>
        </exec>
       <condition property="expected.switchps.response">
         <contains string="${curl.switchps.result}" substring="Persistence standard is JDO"/>
       </condition>
       <fail unless="expected.switchps.response" message="Did not get the expected switchps response: ${curl.switchps.result}${line.separator}${line.separator}    BUILD FAILED!!!!"/>
      </sequential>
    </parallel>
  </target>
</project>
